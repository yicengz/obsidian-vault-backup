
# 案例

日期｜(当天)领券数，(当天)用券用户数｜(全量)领券数，(全量)用券用户数
0501，100，20，100，20
0502，200，30，300，40
0503，300，50，600，70


- 当天：日期对应的是业务日期
- 全量：日期对应的是结算日期



通用SQL如下
``` sql
select 日期
	,  max(当天_领券数   ) as (当天)领券数
	,  max(全量_领券用户数) as (全量)领券用户数
	,  max(当天_领券数   ) as (当天)领券数
	,  max(全量_领券用户数) as (全量)领券用户数
from (
	select 领券日期 as 日期
		,  count(if(领券日期  = '结算日期', ticket_id, null)) as 当天_领券数
		,  count(if(领券日期 >= '周期开始', ticket_id, null)) as 全量_领券用户数
		,  null as 当天_领券数
		,  null as 全量_领券用户数
	from 领券记录
	where 领券日期 >= '周期开始'
	  and 领券日期 <= '结算日期'
	group by 领券日期

	union all

	select 用券日期 as 日期
		,  null as 当天_领券数
		,  null as 全量_领券用户数
		,  count(distinct if(用券日期  = '结算日期', ticket_id, null)) as 当天_领券数
		,  count(distinct if(用券日期 >= '周期开始', ticket_id, null)) as 全量_领券用户数
	from 用券记录
	where 用券日期 >= '周期开始'
	  and 用券日期 <= '结算日期'
	group by 用券日期
) TUnion
group by 日期
```
##### 问题
1. 如何灵活指定**开始日期**和**结束日期**？
	1. 这种场景只适合于case by case的场景
	2. 面对灵活自主上线的场景，怎么做到自动化？
2. 全量数据扫描量可能很大，尤其针对流量
	1. 解决方案之一是可以将需要的数据抽至中间表
3. 如果有复杂的维度，比如历史数据需要用历史的维度（用户第一次进入时的分层）
	1. 待定
		1. 方法1是使用中间表存储每天的全量
		2. 方法2是每次都用开窗计算用户的第一次